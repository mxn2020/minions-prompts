# minions-prompts Specification v0.1

## 1. Motivation and Goals

Prompts are the primary interface between developers and language models. Yet most teams manage prompts as string constants scattered through codebases — no versioning, no testing, no way to compare variations or roll back regressions.

`minions-prompts` treats prompts as first-class versioned objects. Every change is tracked. Every version can be tested. Every A/B experiment is reproducible. This is version control for prompts, built on the Minions structured object system.

**Goals:**
- Provide full version history for every prompt template
- Enable systematic test-driven prompt development
- Support A/B comparison of prompt variations with measurable metrics
- Allow agents to version their own system prompts (self-improvement infrastructure)
- Maintain cross-language compatibility (TypeScript and Python produce identical JSON)

## 2. Glossary

| Term | Definition |
|------|-----------|
| **Prompt Template** | A reusable prompt with `{{variable}}` placeholders, representing the canonical "current" version |
| **Prompt Version** | A snapshot of a prompt at a specific point in time, linked to its predecessor via a `follows` relation |
| **Variable** | A named placeholder in a template, typed and optionally required |
| **Version Chain** | The ordered sequence of prompt versions connected by `follows` relations |
| **Test Case** | A set of input variables and expected output criteria for validating a prompt |
| **Test Result** | The output of running a test case against a prompt, including scores per dimension |
| **A/B Comparison** | Running two prompt versions against the same test inputs and comparing their scores |
| **Rendered Prompt** | A prompt after all `{{variables}}` have been substituted with actual values |
| **Score** | A numeric value (0–100) measuring prompt quality along a named dimension |

## 3. Core Type Definitions

### 3.1 prompt-template

The top-level prompt object. Represents the living, current state of a prompt.

```
MinionType ID: minions-prompts/prompt-template
Slug: prompt-template
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| content | textarea | yes | The prompt body with `{{variable}}` placeholders |
| description | string | no | Purpose and usage notes |
| variables | tags | no | List of variable names referenced in this template |
| tags | tags | no | Freeform categorization tags |

### 3.2 prompt-version

A versioned snapshot of a prompt. Linked to its predecessor via a `follows` relation.

```
MinionType ID: minions-prompts/prompt-version
Slug: prompt-version
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| content | textarea | yes | The versioned prompt body |
| description | string | no | Purpose notes |
| versionNumber | number | no | Semantic version (e.g. 1, 2, 3) |
| changelog | string | no | What changed in this version |
| variables | tags | no | Variable names referenced |
| tags | tags | no | Freeform categorization |

Relations:
- `follows` → previous `prompt-version` or `prompt-template`

### 3.3 prompt-variable

A typed variable definition with optional default and examples.

```
MinionType ID: minions-prompts/prompt-variable
Slug: prompt-variable
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| variableType | select | yes | One of: string, number, boolean, array, object |
| description | string | no | What this variable represents |
| defaultValue | string | no | Default value as serialized string |
| required | boolean | yes | Whether callers must supply this variable |
| example | string | no | Example value for documentation |

Options for `variableType`: `string`, `number`, `boolean`, `array`, `object`

### 3.4 prompt-test

A test case: input variables + expected behavior criteria.

```
MinionType ID: minions-prompts/prompt-test
Slug: prompt-test
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| inputVariables | json | yes | Object mapping variable names to test values |
| expectedCriteria | textarea | no | Human-readable description of expected output |
| scoringDimensions | tags | no | Dimensions to score (e.g. relevance, coherence) |

### 3.5 prompt-result

The result of running a test case against a prompt version.

```
MinionType ID: minions-prompts/prompt-result
Slug: prompt-result
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| renderedPrompt | textarea | yes | The prompt after variable substitution |
| output | textarea | no | Actual LLM output (if captured) |
| scores | json | yes | Object mapping dimension names to scores (0–100) |
| metadata | json | no | Model name, temperature, token counts, etc. |
| passed | boolean | yes | Whether this test result is considered passing |

Relations:
- `references` → `prompt-test` (which test was run)
- `references` → `prompt-version` or `prompt-template` (which prompt was tested)

## 4. Variable Interpolation Syntax

### 4.1 Basic Substitution

Variables are delimited by double curly braces:

```
{{variable_name}}
```

Variable names must match `[a-zA-Z_][a-zA-Z0-9_]*`. Whitespace inside delimiters is trimmed.

### 4.2 Conditional Blocks

```
{{#if condition}}
  Content shown when condition is truthy
{{/if}}
```

The `condition` must be a variable name. A value is truthy if it is non-null, non-empty, and not the boolean `false`.

### 4.3 Iteration Blocks

```
{{#each items}}
  Item: {{this}}
{{/each}}
```

For objects in the collection:
```
{{#each users}}
  Name: {{name}}, Role: {{role}}
{{/each}}
```

### 4.4 Escaping

To output literal `{{`, use `\{{`. The backslash is consumed during rendering.

## 5. Version Chain Semantics

A version chain is a directed linked list of `prompt-version` minions connected by `follows` relations:

```
prompt-template (root)
    ↑ follows
prompt-version v1
    ↑ follows
prompt-version v2  ← latest
```

Rules:
1. The `sourceId` of a `follows` relation is the NEWER version; `targetId` is the OLDER version.
2. A version chain has exactly one root (a `prompt-template` or a version with no predecessor).
3. Branching is allowed: multiple versions can follow the same predecessor. The "latest" version is determined by `createdAt` timestamp among leaf nodes.
4. `getVersionChain()` returns all versions in chronological order (oldest first).

## 6. Test Case Structure

A test case consists of:
- **inputVariables**: A JSON object mapping variable names to concrete values
- **expectedCriteria**: Natural-language description of what the rendered output should accomplish
- **scoringDimensions**: An array of dimension names (e.g. `["relevance", "coherence", "accuracy"]`)

Scoring is external — the `PromptScorer` creates `prompt-result` minions with scores supplied by the caller (e.g. a human evaluator or an LLM judge). Scores are integers 0–100.

A test **passes** if the caller marks `passed: true` in the result.

## 7. Export Format Specifications

### 7.1 Raw String

The rendered prompt as a plain string with all variables substituted. Useful for direct API calls.

### 7.2 LangChain Format

```json
{
  "template": "...",
  "inputVariables": ["var1", "var2"],
  "outputParser": null
}
```
Compatible with LangChain's `PromptTemplate` constructor.

### 7.3 LlamaIndex Format

```json
{
  "template": "...",
  "templateVars": ["var1", "var2"]
}
```
Compatible with LlamaIndex's `PromptTemplate`.

### 7.4 Full JSON Export

A complete export including:
- The prompt minion
- All linked versions (via `follows` chain)
- All linked test results (via `references`)

## 8. Diff Algorithm

The diff compares two prompt versions field by field:

```
DiffResult {
  added: Array<{ field, value }>          // fields present in v2 but not v1
  removed: Array<{ field, value }>        // fields present in v1 but not v2
  changed: Array<{ field, from, to }>     // fields present in both but different
}
```

For the `content` field, a line-level diff is also produced (array of `DiffLine` objects with `type: 'add' | 'remove' | 'context'` and `text: string`).

## 9. Best Practices

1. **Create a test case before bumping a version.** Treat prompt development like TDD.
2. **Use descriptive `changelog` on every version bump.** Future you will thank you.
3. **Define all variables explicitly.** Don't rely on implicit string replacement — register each variable.
4. **Score multiple dimensions.** A single overall score hides regressions in specific areas.
5. **Keep templates focused.** A prompt that does one thing well beats a prompt that attempts ten.

## 10. Conformance Checklist

An implementation conforms to this spec if it:

- [ ] Implements all five Minion Types with the exact field schemas above
- [ ] Supports `{{variable}}` interpolation with validation of required variables
- [ ] Supports `{{#if}}` and `{{#each}}` template blocks
- [ ] Traverses `follows` relations to reconstruct full version chains
- [ ] Produces `DiffResult` objects in the format above
- [ ] Exports to raw, LangChain, LlamaIndex, and JSON formats
- [ ] Serializes minions to camelCase JSON compatible with `minions-sdk`
- [ ] Raises a clear error when required variables are missing during rendering
