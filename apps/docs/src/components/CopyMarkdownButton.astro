---
/**
 * CopyMarkdownButton â€” Starlight Head override.
 * Extends the default Head and injects a "Copy as Markdown" button 
 * into the page via a client-side script.
 */
import type { Props } from '@astrojs/starlight/props';
import Default from '@astrojs/starlight/components/Head.astro';
---

<Default {...Astro.props}><slot /></Default>

<!-- Cross-page language tab persistence -->
<script>
  const STORAGE_KEY = 'starlight-synced-tabs__lang';

  function persistLanguageChoice() {
    document.addEventListener('click', (e) => {
      const btn = (e.target as HTMLElement).closest('[role="tab"]');
      if (!btn) return;
      const tablist = btn.closest('[role="tablist"]');
      if (!tablist) return;
      const panel = tablist.closest('starlight-tabs');
      if (!panel?.getAttribute('data-sync-key')) return;
      const label = btn.textContent?.trim();
      if (label) localStorage.setItem(STORAGE_KEY, label);
    });
  }

  document.addEventListener('astro:page-load', persistLanguageChoice);
  persistLanguageChoice();
</script>

<script>
  function createCopyButton() {
    // Skip on the introduction/index page
    const path = window.location.pathname.replace(/\/$/, '') || '';
    if (path === '' || path === '/') return;

    // Find the page title
    const titleEl = document.querySelector('.content-panel h1, article h1, main h1');
    if (!titleEl) return;

    // Don't add duplicate buttons
    if (document.getElementById('copy-md-btn')) return;

    const btn = document.createElement('button');
    btn.id = 'copy-md-btn';
    btn.title = 'Copy page as Markdown';
    btn.setAttribute('aria-label', 'Copy page as Markdown');
    btn.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" 
           stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 3v4a1 1 0 0 0 1 1h4"/>
        <path d="M17 21H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7l5 5v11a2 2 0 0 1-2 2z"/>
        <path d="M9 17h6"/>
        <path d="M9 13h6"/>
      </svg>
      <span class="copy-md-label">Copy MD</span>
    `;

    btn.addEventListener('click', async () => {
      const label = btn.querySelector('.copy-md-label') as HTMLSpanElement;
      try {
        btn.classList.add('loading');
        const md = await fetchMarkdownSource();
        await navigator.clipboard.writeText(md);
        btn.classList.remove('loading');
        btn.classList.add('copied');
        label.textContent = 'Copied!';
        setTimeout(() => {
          btn.classList.remove('copied');
          label.textContent = 'Copy MD';
        }, 2000);
      } catch (err) {
        btn.classList.remove('loading');
        btn.classList.add('error');
        label.textContent = 'Failed';
        setTimeout(() => {
          btn.classList.remove('error');
          label.textContent = 'Copy MD';
        }, 2000);
        console.error('Copy Markdown failed:', err);
      }
    });

    // Insert button next to the h1
    titleEl.style.position = 'relative';
    titleEl.appendChild(btn);
  }

  async function fetchMarkdownSource(): Promise<string> {
    const path = window.location.pathname.replace(/\/$/, '') || '';
    const base = 'https://raw.githubusercontent.com/mxn2020/minions-prompts/main/apps/docs/src/content/docs';
    
    // Try these paths in order:
    // 1. /path.mdx      (top-level page)
    // 2. /path/index.mdx (directory-style page)
    // 3. /path.md        (plain markdown)
    // 4. /path/index.md
    const candidates = path === ''
      ? [`${base}/index.mdx`, `${base}/index.md`]
      : [`${base}${path}.mdx`, `${base}${path}/index.mdx`, `${base}${path}.md`, `${base}${path}/index.md`];

    for (const url of candidates) {
      const res = await fetch(url);
      if (res.ok) return res.text();
    }

    throw new Error('Could not find markdown source');
  }

  // Run on initial load and on Starlight client-side navigation
  document.addEventListener('astro:page-load', createCopyButton);
  createCopyButton();
</script>

<style is:global>
  #copy-md-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    padding: 0.3rem 0.6rem;
    border: 1px solid var(--sl-color-gray-5, #444);
    border-radius: 0.375rem;
    background: var(--sl-color-bg-nav, transparent);
    color: var(--sl-color-gray-3, #aaa);
    font-size: 0.75rem;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.15s ease;
    white-space: nowrap;
    z-index: 10;
  }

  #copy-md-btn:hover {
    border-color: var(--sl-color-accent, #6d5dfc);
    color: var(--sl-color-white, #fff);
    background: var(--sl-color-gray-6, #1a1a2e);
  }

  #copy-md-btn.copied {
    border-color: #22c55e;
    color: #22c55e;
  }

  #copy-md-btn.error {
    border-color: #ef4444;
    color: #ef4444;
  }

  #copy-md-btn.loading {
    opacity: 0.6;
    cursor: wait;
  }

  #copy-md-btn svg {
    flex-shrink: 0;
  }

  /* On small screens, show icon only */
  @media (max-width: 50rem) {
    .copy-md-label {
      display: none;
    }
  }
</style>
