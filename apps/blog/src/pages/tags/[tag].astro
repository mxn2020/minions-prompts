---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/blog/PostCard.astro';
import { ArrowLeft } from 'lucide-react';

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => {
    return import.meta.env.PROD ? data.draft !== true : true;
  });

  const tags = [...new Set(posts.flatMap(post => post.data.tags || []))];

  return tags.map(tag => {
    const filteredPosts = posts.filter(post => post.data.tags?.includes(tag));
    // Sort remaining
    filteredPosts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
    
    return {
      params: { tag },
      props: { posts: filteredPosts },
    };
  });
}

const { tag } = Astro.params;
const { posts } = Astro.props;
---

<BaseLayout 
  title={`Posts tagged "${tag}" | Minions Blog`} 
  description={`Browse all blog posts tagged with ${tag}`}
>
  <div class="container mx-auto px-4 md:px-6 py-12 max-w-6xl">
    <div class="mb-8">
      <a href="/" class="inline-flex items-center text-sm font-medium text-muted hover:text-accent transition-colors">
        <ArrowLeft className="w-4 h-4 mr-2" />
        Back to all posts
      </a>
    </div>

    <header class="mb-12">
      <h1 class="text-3xl md:text-5xl font-bold text-primary tracking-tight mb-4">
        Posts tagged <span class="text-accent underline decoration-accent/30 decoration-wavy">#{tag}</span>
      </h1>
      <p class="text-muted text-lg">
        Found {posts.length} {posts.length === 1 ? 'post' : 'posts'}
      </p>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
      {posts.map((post) => (
        <PostCard post={post} />
      ))}
    </div>
  </div>
</BaseLayout>
